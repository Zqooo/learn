åœ¨vnode&render.mdä¸­ï¼Œåªåœåœ¨æ¨¡æ¿æ¸²æŸ“çš„å±‚é¢ï¼ŒåŽç»­çš„diffç®—æ³•æ¯”è¾ƒåœ¨patchå®žçŽ°ï¼Œåœ¨è¿™è¾¹è¿›è¡Œç»­å†™

âœ¨ diffç®—æ³•
  1.ç”¨æˆ·åœ¨æ“ä½œdomèŠ‚ç‚¹æ—¶ï¼Œå°‘æœ‰å°†å­èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹äº’æ¢çš„æ“ä½œï¼Œæ‰€ä»¥åœ¨vueä¸­æ²¡æœ‰è€ƒè™‘æ•´æ£µæ ‘å®Œæ•´å¯¹æ¯”çš„é€»è¾‘ï¼Œæ€§èƒ½ä¼šå¾ˆå·®
  2.diffç®—æ³•é‡‡ç”¨åŒçº§èŠ‚ç‚¹å¯¹æ¯”
    ç»“åˆç¬¬ä¸€ç‚¹ä¸¾ä¾‹ï¼Œ a -> a1,a2  |  a1 -> a,a2 
    å¦‚æžœè¿›è¡Œæ•´æ£µæ ‘çš„éåŽ†å¯¹æ¯”ï¼Œå¯ä»¥çœ‹å‡ºçˆ¶èŠ‚ç‚¹aå’Œå­èŠ‚ç‚¹a1äº’æ¢ï¼Œå†è¿›è¡ŒèŠ‚ç‚¹å¤ç”¨ï¼Œä½†è¿™æ ·åšåè€Œæ¶ˆè€—æ›´å¤šæ€§èƒ½
    vue2å’Œvue3çš„diffç®—æ³•æ˜¯åŒçº§æ¯”è¾ƒï¼Œå½“ a å’Œ a1 ä¸åŒçš„æ—¶å€™ï¼Œç›´æŽ¥å°†aæ›¿æ¢æˆa1 ï¼Œä¸åšå¯¹æ¯”
  
  3.vue2ä¸­ï¼Œä¸¤æ¬¡æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œå¦‚æžœèŠ‚ç‚¹å‰åŽæ²¡å˜åŒ–ï¼Œä»ç„¶ä¼šåŒçº§é€å±‚å¯¹æ¯”
    vue3ä¸­å¯¹æ­¤æƒ…æ™¯è¿›è¡Œäº†ä¼˜åŒ– -> é¶å‘æ›´æ–°
    ä¼šè¿›è¡Œå°†åŠ¨æ€èŠ‚ç‚¹å­˜åœ¨æ•°ç»„ä¸­ï¼Œé™æ€èŠ‚ç‚¹ä¸ç”¨è¿›è¡Œå¯¹æ¯”ï¼ŒåŠ¨æ€èŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”


âœ¨ diffæ•´ç†æµç¨‹ç®€è¿°
  renderæ¸²æŸ“å™¨
   -> patchèŠ‚ç‚¹æ¸²æŸ“å‡½æ•°ï¼ˆæ–°èŠ‚ç‚¹æŒ‚è½½/æ—§èŠ‚ç‚¹å¯¹æ¯”æ¸²æŸ“ï¼‰
    1.åˆ¤æ–­æŒ‚è½½çš„å®¹å™¨ä¸Šæ˜¯å¦å·²ç»æœ‰è™šæ‹ŸèŠ‚ç‚¹æ ‡è¯†
      è‹¥æœ‰ï¼Œåˆ™å’Œæ–°è™šæ‹ŸèŠ‚ç‚¹è¿›è¡Œç›¸åŒç‰¹æ€§åˆ¤æ–­(isSameVNode)ï¼Œç¡®å®šæ˜¯å¦å¸è½½æ—§èŠ‚ç‚¹
    2.åˆ¤æ–­è¯¥èŠ‚ç‚¹ç±»åž‹
      Text  -> processText
      other -> processElement
   -> processElement èŠ‚ç‚¹æŒ‚è½½é€»è¾‘å¤„ç†å‡½æ•°
    åˆ¤æ–­å½“æ˜¯å¦æœ‰æ—§èŠ‚ç‚¹
      åœ¨patchä¸­èµ°isSameVNodeå‡½æ•°ï¼Œè‹¥æœ‰ç›¸åŒç‰¹æ€§ï¼Œåˆ™ä¿ç•™ï¼Œè‹¥æ²¡æœ‰ï¼Œåˆ™å¸è½½
      æ— ä¿ç•™æ—§è™šæ‹ŸèŠ‚ç‚¹ -> mountElement æ‰§è¡Œç›´æŽ¥æŒ‚è½½èŠ‚ç‚¹å‡½æ•°
      æœ‰ä¿ç•™æ—§è™šæ‹ŸèŠ‚ç‚¹ -> patchElement æ‰§è¡Œdiffå¯¹æ¯”æ›´æ–°å‡½æ•°
   -> patchElement èŠ‚ç‚¹å¯¹æ¯”æŒ‚è½½å‡½æ•°(diffæ ¸å¿ƒé€»è¾‘å‡½æ•°)
      1.æ›´æ–°å½“å‰èŠ‚ç‚¹çš„å±žæ€§ patchProps
      2.å­èŠ‚ç‚¹æ·±å±‚å¯¹æ¯”å‡½æ•° patchChildren
   -> patchChildren
      æ ¹æ®shapeFlagåˆ¤æ–­æ–°æ—§èŠ‚ç‚¹çš„æ•°æ®ç±»åž‹ï¼Œè¿›è¡Œå¯¹åº”æ“ä½œ
      åˆ†åˆ«æ˜¯ 
        æ—§æ•°ç»„ æ–°æ•°ç»„/æ–°æ–‡æœ¬/æ–°ç©º
        æ—§æ–‡æœ¬ æ–°æ•°ç»„/æ–°æ–‡æœ¬/æ–°ç©º
        æ—§ç©º   æ–°æ•°ç»„/æ–°æ–‡æœ¬/æ–°ç©º
      ç¬¬ä¸‰ç»„åœ¨processText/processElement å·²ç»ç›´æŽ¥è¿›è¡ŒæŒ‚è½½ï¼Œä¸»è¦æ˜¯å¤„ç†å‰ä¸¤ç»„çš„æƒ…æ™¯
      
      1.æƒ…æ™¯ä¸€ æ–°æ–‡æœ¬ æ—§æ–‡æœ¬/æ—§æ•°ç»„ 
        -> æ—§æ•°ç»„ä¸­çš„èŠ‚ç‚¹ä¾æ¬¡å¸è½½ unmountChildren(for & unmount(child))
        -> åˆ¤æ–­æ—§æ–‡æœ¬å’Œæ–°æ–‡æœ¬æ˜¯å¦ç›¸ç­‰
        é€šè¿‡hostSetElementText å°†æ–°æ–‡æœ¬è¦†ç›–åˆ°çˆ¶èŠ‚ç‚¹çš„æ–‡æœ¬èŠ‚ç‚¹ä¸­
      2.æƒ…æ™¯äºŒ æ—§æ•°ç»„ 
        2-1 æ–°æ•°ç»„ èµ°diff ðŸ’¡
        2-1 æ–°ç©º æ—§æ•°ç»„ä¸­çš„èŠ‚ç‚¹ä¾æ¬¡å¸è½½ unmountChildren(for & unmount(child))
      3.æƒ…æ™¯ä¸‰ æ—§æ–‡æœ¬ åˆ›å»ºç©ºæ–‡æœ¬èŠ‚ç‚¹ç›´æŽ¥è¿›è¡Œè¦†ç›–
        3-1 æ–°æ•°ç»„ éåŽ†æŒ‚è½½æ–°èŠ‚ç‚¹
        3-2 æ–°ç©º   æ— éœ€ä»»ä½•æ“ä½œ

ðŸ’¡ diffç®—æ³•æ¯”è¾ƒ

  ðŸš© 1.å¸¸è§„åºåˆ—çš„æ¯”è¾ƒ 
  ä¸‰æŒ‡é’ˆæŽ¨åŠ¨ i e1 e2
  e1å’Œe2ä¸ºæ–°æ—§èŠ‚ç‚¹çš„æœ«å°¾é¡¹ï¼Œiä¸ºé¦–ä½ç´¢å¼•
  sync from start 
    ä»Žé¦–å°¾å‘æœ«å°¾æŽ¨åŠ¨(i -> e1/e2)
  sync from start 
    ä»Žæœ«å°¾å‘é¦–ä½æŽ¨åŠ¨(e1/e2 -> i)
  ä¸¤ä¸ªè¿‡ç¨‹ä¸­ï¼ŒèŠ‚ç‚¹æœ‰ç›¸åŒç‰¹æ€§åˆ™ç›´æŽ¥èµ°patchæŒ‚è½½
  å½“æ–°æ—§èŠ‚ç‚¹ä¸ç›¸ç­‰æ—¶åœæ­¢éåŽ†ï¼ŒæŒ‡é’ˆå¾€å‰æŽ¨ä¸€ä½(i++/e1--,e2--)ï¼Œåœç•™åœ¨ä¸åŒé¡¹
  
  ðŸš© 2.å¸¸è§„åºåˆ—ä¸‹æº¢å‡ºèŠ‚ç‚¹çš„å¢žåˆ 

  ç®€å•åˆ—ä¸¾æ–°æ—§èŠ‚ç‚¹çš„ä¸¤ç§æƒ…æ™¯
  æƒ…æ™¯ä¸€: æ–°èŠ‚ç‚¹æ¯”æ—§èŠ‚ç‚¹å¤š
  a b c d e    &    b c d e f 
  a b c d e f     a b c d e f
  
  æƒ…æ™¯äºŒ: æ—§èŠ‚ç‚¹æ¯”æ–°èŠ‚ç‚¹å¤š
  a b c d e f  &  a b c d e f 
  a b c d           b c d e f
  ï¼ˆä¸åšè¯¦ç»†åˆ†æžï¼Œæ ¹æ®start or end çš„é€»è¾‘ï¼Œå°±å¯ä»¥çœ‹åˆ°iå’Œe1/e2å¯¹æ¯”çš„å·®åˆ«ï¼‰
  åˆ¤æ–­iæ‰€åœ¨çš„ä½ç½®ï¼Œ
  1. i>e1çš„æ¡ä»¶ä¸‹ï¼Œæ˜¯æ–°èŠ‚ç‚¹æ¯”æ—§èŠ‚ç‚¹å¤š
    åˆ™å½“å‰æ˜¯iåˆ°e2çš„è·ç¦»ï¼Œå¾ªçŽ¯è·ç¦»å€¼ï¼Œè¿›è¡Œæ–°èŠ‚ç‚¹çš„æŒ‚è½½
    
    anchor æ–°èŠ‚ç‚¹æ’å…¥çš„ä½ç½®
    insertBefore(el, container, anchor) å¾€anchorèŠ‚ç‚¹å‰è¿›è¡Œæ–°èŠ‚ç‚¹çš„æ’å…¥/ç§»åŠ¨
    åˆ¤æ–­e2æ˜¯å¦ä¸ºæœ«å°¾é¡¹:
      e2 + 1 è‹¥è¶…å‡ºå­å…ƒç´ é•¿åº¦ï¼Œåˆ™ä¸ºæœ«å°¾é¡¹ï¼Œanchor ä¸ºnull
      e2 + 1 è‹¥æ²¡è¶…å­å…ƒç´ é•¿åº¦ï¼Œåˆ™éžæœ«å°¾é¡¹ï¼Œanchor ä¸ºæ’å…¥ç‚¹
    èµ°patché€»è¾‘ æ–°è¡Œæ–°èŠ‚ç‚¹æŒ‚è½½
  2. i>e2çš„æ¡ä»¶ä¸‹ï¼Œæ˜¯æ—§èŠ‚ç‚¹æ¯”æ–°èŠ‚ç‚¹å¤š
    åˆ™å½“å‰æ˜¯iåˆ°e1çš„è·ç¦»ï¼Œå¾ªçŽ¯è·ç¦»å€¼ï¼Œè¿›è¡Œæ—§èŠ‚ç‚¹çš„å¸è½½

  ðŸš© 3. uknown sequence
  ç»è¿‡å‰ä¸¤æ­¥ï¼Œå·²ç»å°†å‰åŽå¸¸è§„åºåˆ—èŠ‚ç‚¹å–å‡ºï¼Œå‰©ä¸‹çš„æ˜¯æœªçŸ¥åºåˆ—èŠ‚ç‚¹

  åœºæ™¯ç®€å•ä¸¾ä¾‹ ---- part1
  [ 0, 2, 3 ]
  a b(s1) c d e(e1) f g
  a b(s2) q c d(e2) f g
  éœ€è¦å››æŒ‡é’ˆè¿›è¡Œå¯¹æ¯”ï¼Œåˆ†åˆ«æ˜¯s1ï¼Œs2ï¼Œe1ï¼Œe2
    
  vue2ä¸­æ˜¯æ–°èŠ‚ç‚¹åŽ»æ—§èŠ‚ç‚¹ä¸­å¯»æ‰¾å¤ç”¨ï¼Œvue3æ˜¯æ–°èŠ‚ç‚¹åŽ»æ–°èŠ‚ç‚¹ä¸­åˆ¤æ–­è‡ªèº«çš„å½’å±ž
  åˆ†ä¸¤æ­¥è¿›è¡Œ
  1. é€šè¿‡Mapåˆ›å»ºæ–°èŠ‚ç‚¹æ˜ å°„è¡¨(s2 -> e2)
      éåŽ†æ—§èŠ‚ç‚¹æ•°ç»„ï¼Œåœ¨æ˜ å°„è¡¨ä¸­æŸ¥è¯¢è‡ªèº«æ˜¯å¦å­˜åœ¨ï¼Œ
      ä¸å­˜åœ¨ï¼Œå¸è½½
      å­˜åœ¨ï¼Œpatchæ¸²æŸ“(èµ°å¯¹æ¯”æ›´æ–°é€»è¾‘)

  2. to sequenced node æ‘†æ­£èŠ‚ç‚¹åºåˆ—
  
    å‰æï¼š åœ¨ç¬¬ä¸€æ­¥ä¸­ï¼Œä¸å­˜åœ¨çš„æ—§èŠ‚ç‚¹å·²ç»å¸è½½ï¼Œå­˜åœ¨çš„æ—§èŠ‚ç‚¹å·²ç»æ›´æ–°çŠ¶æ€ï¼Œä½†æœªæ›´æ­£ä½ç½®
    
    é€šè¿‡insertBefore APIçš„ç‰¹ç‚¹ï¼Œæ–°å¢žèŠ‚ç‚¹å¯ä»¥è¿›è¡Œæ’å…¥ï¼Œå­˜åœ¨çš„èŠ‚ç‚¹å¯ä»¥æ›´æ­£ä½ç½®

    toBePatched: e2 - s2 + 1 
    toBePatched æ˜¯ unknown sequence æœªçŸ¥é˜Ÿåˆ—çš„é•¿åº¦ï¼ˆä¸‹é¢ç®€ç§°usï¼Œæ˜¯æ–°èŠ‚ç‚¹çš„æœªçŸ¥åºåˆ—ç‰‡æ®µï¼‰
    
    åˆ° to sequenced node çŽ¯èŠ‚ï¼Œs1å·²ç»æŽ¨åŠ¨åˆ°uså‰ï¼Œç›´æŽ¥åˆ°æœªçŸ¥åºåˆ—çš„æœ«ä½ï¼Œé€æ­¥å¾€å‰æ›´æ­£
    
    ä»Žæœ«ä½å¼€å§‹æ‘†æ­£é€»è¾‘ï¼Œé€šè¿‡ part1 å¯çœ‹ï¼Œæ‘†æ­£è¿‡ç¨‹æ˜¯å¯¹ unknown sequenceçš„æœ«ä½è¿›è¡Œæ’å…¥ï¼Œæ‰¾åˆ°fï¼Œå°†eæ›´æ­£åˆ°få‰

    å–å‡ºusçš„æœ€æœ«ä½ä¸Žä¸‹ä¸€ä½è¿›è¡Œåˆ¤æ–­
      è‹¥ä»–çš„ä¸‹ä¸€ä½è¶…å‡ºæ–°èŠ‚ç‚¹æœ¬èº«çš„é•¿åº¦ï¼Œåˆ™anchor(é”š)ä¸éœ€è¦å­˜å€¼ï¼Œç›´æŽ¥æŸ¥åˆ°
      è‹¥ä»–çš„ä¸‹ä¸€ä½æœ‰å€¼ï¼Œåˆ™ä»¥ä¸‹ä¸€ä½ä½œä¸ºanchor(é”š)è¿›è¡Œæ’å…¥/æ›´æ­£ä½ç½®

      anchorä¸ºnullçš„åœºæ™¯
      a b c d e
      a b q c d
 
    åˆ¤æ–­å½“å‰usçš„æœ«ä½æœ‰æ²¡æœ‰æºå¸¦çœŸå®žèŠ‚ç‚¹
      è‹¥æ²¡æœ‰ï¼Œåˆ™æ˜¯æ–°å¢žèŠ‚ç‚¹ï¼Œèµ°patchæ–°å¢žé€»è¾‘
      è‹¥æœ‰ï¼Œåˆ™æ˜¯åœ¨uknown sequenceç¬¬ä¸€çŽ¯èŠ‚ä¸­å·²ç»å¤ç”¨æ¸²æŸ“çš„èŠ‚ç‚¹ï¼Œé€šè¿‡hostInsertè¿›è¡Œä½ç½®æ›´æ­£

  3. diff

  åœ¨ to sequenced node çš„æ­¥éª¤è¿‡ç¨‹ä¸­ï¼Œæ˜¯å…ˆæ·»å…¥ï¼Œå†æŽ’åº
  
  âœ¨ åœ¨ä¼˜åŒ–ä¸­ï¼Œåº”è¯¥æ˜¯ç¡®å®šæœ€é•¿é€’å¢žå­åºåˆ—ï¼Œç„¶åŽè¿›è¡Œä¼˜åŒ–æŽ’åºï¼Œä¸ç”¨æ¯ä¸ªéƒ½æŽ’åº

  a b [c d e] f g
  a b [q c d] f g 

  1. set new node Map -> 
    const keyToNewIndexMap = new Map() 
    [q c d]
    forEach the new node list --> {q:2, c:3, d:4}
  
  2. set uknown sequence list ->
    const seq = new Array(toBePatched).fill(0) -> seq [0, 0, 0]
    
    <!-- èŽ·å–çš„èŠ‚ç‚¹ä¸­ï¼Œè‹¥æœ‰å€¼ï¼Œåˆ™å¯»æ‰¾æœ€é•¿é€’å¢žå­åºåˆ—çš„é•¿åº¦ -->
    old us list : [c d e]
    forEach the old us list --> seq [0, 3, 4] 

  3. get the lingest child sequence -> getSequence
    
    

    
    
  
    
    
    
      
