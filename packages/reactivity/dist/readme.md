ğŸªğŸªğŸªV3å“åº”å¼æ‹†è§£ğŸªğŸªğŸª

âœ¨reactiveæ¨¡å—
  å®ç°æ•°æ®ä»£ç†ï¼Œåç»­æ“ä½œçš„æ˜¯ä»£ç†å¯¹è±¡ï¼Œé€šè¿‡ä»£ç†çš„å¯¹è±¡çš„getå’Œsetç‰¹æ€§è¿›è¡Œè¿›ä¸€æ­¥æ“ä½œ
  ğŸš© é—®é¢˜ï¼šå…ƒæ•°æ®é‡å¤ä»£ç†ï¼Œä»£ç†å¯¹è±¡é‡å¤ä»£ç†ï¼Œæ·±å±‚ä»£ç†
  ğŸŒ è§£å†³æ€è·¯ï¼š
    âš½ï¸ åˆ›å»ºreactiveMapè¡¨ï¼Œå·²ç»ä»£ç†çš„æ•°æ®å­˜æ”¾åˆ°è¡¨ä¸­ï¼Œåœ¨ä»£ç†å‰åˆ¤æ–­è¡¨ä¸­æ˜¯å¦å·²ç»å­˜æ”¾è¯¥æ•°æ®ï¼Œè‹¥å­˜æ”¾ï¼Œåˆ™è¡¨ç¤ºè¯¥æ•°æ®å·²ç»è¿›è¡Œä»£ç†ï¼Œæ— éœ€é‡å¤ä»£ç†ï¼Œä»è¡¨ä¸­å–å‡ºä»£ç†å¯¹è±¡è¿›è¡Œè¿”å›
    âš½ï¸ å·²ä»£ç†æ•°æ®åœ¨proxy.getä¸­è®¾ç½®é˜€é—¨(ReactiveFlags.IS_REACTIVE)ï¼Œè‹¥ç›®æ ‡æ•°æ®å·²è¢«ä»£ç†ï¼Œåˆ™è®¿é—®è¯¥é˜€å€¼æ—¶ï¼Œä¼šè¿”å›trueï¼ˆæœªä»£ç†çš„å…ƒæ•°æ®èº«ä¸Šæ²¡æœ‰è¯¥å±æ€§ï¼Œåªä¼šè¿”å›undefinedï¼‰ï¼Œé€šè¿‡é˜€å€¼åˆ¤æ–­ï¼Œç¡®å®šæ˜¯å¦ç»§ç»­è¿›è¡Œå¯¹è±¡ä»£ç†
    âš½ï¸ effectå–å€¼æ—¶ï¼Œproxyä¼šç»è¿‡geté€»è¾‘ï¼Œå–å€¼æ—¶åˆ¤æ–­æ˜¯å¦ä¸ºå¯¹è±¡ï¼Œè‹¥ä¸ºå¯¹è±¡ï¼Œåˆ™è¿›ä¸€æ­¥è¿›è¡Œæ•°æ®ä»£ç†ï¼ˆåœ¨ä»£ç†è¿‡ç¨‹ä¸­å°±æœ‰åˆ¤æ–­æ˜¯å¦å·²ç»ä»£ç†çš„é€»è¾‘ï¼‰
    
âœ¨effectæ¨¡å—
  é€»è¾‘è°ƒç”¨å‡½æ•°ï¼Œè¿›è¡Œè§†å›¾æ›´æ–°
    âœ¨ => ReactiveEffectï¼ˆé¢å¯¹å¯¹è±¡æ“ä½œï¼‰
      ğŸŒ æ¯ä¸ªeffectéƒ½æ˜¯è¿™ä¸ªç±»ä¸‹çš„å®ä¾‹ï¼Œè¿™æ ·æ¯ä¸ªeffectéƒ½æœ‰å±äºè‡ªå·±çš„å±æ€§æ± ï¼Œè¿›è¡Œæ‰©å±•æ“ä½œ
      -----
      å­ç±»æ–¹æ³•ï¼ˆåˆ›å»ºå®ä¾‹å¯¹è±¡ä¼ è¿›æ¥çš„å‚æ•°ï¼‰
      ğŸš©fn,effectå¯¹åº”çš„è§†å›¾æ›´æ–°å‡½æ•°
      ğŸš©ï¼ˆoptionsï¼‰schedulerï¼Œè°ƒåº¦å‡½æ•°
        å½“effectä¸­ä¼ å…¥scheduleræ—¶ï¼Œä¸èµ°é»˜è®¤çš„è§†å›¾æ›´æ–°é€»è¾‘ï¼Œè€Œæ˜¯æ‰§è¡Œä¼ è¿›æ¥çš„schedulerå‡½æ•°ï¼Œç”¨æˆ·å¯ä»¥åœ¨è¯¥å‡½æ•°ä¸­æ‰‹åŠ¨æ‰§è¡Œeffectå®ä¾‹ä¸Šçš„æ–¹æ³•ï¼Œæ‰©å±•é€»è¾‘é“¾
      -----
      ğŸš©depsï¼Œç”¨äºæ”¶é›†effectä¸­å¯¹åº”å¼•ç”¨äº†å“ªäº›æ•°æ®
        âš½ï¸ åœ¨cleanEffectä¸­ï¼Œé€šè¿‡depså»å°†æ‰€æœ‰ä¾èµ–å…³ç³»æ¸…é™¤
          Â·depså­˜æ”¾çš„æ˜¯ä»£ç†å¯¹è±¡ä¸Šï¼Œå±æ€§å¯¹åº”çš„Set[]
          exampleï¼š
            reactiveMap:{
              proxy:{ 
                flag:[effect1,effect2,...]
                name:[effect14,effect24,...]
              }
            }
          effect.deps = [proxy[flag],proxy[name]]
          ğŸŒŸ åœ¨ä»»ä½•å­˜åœ¨ä¾èµ–å…³ç³»çš„è¡¨ä¸­ï¼Œå»é™¤å½“å‰effectï¼Œ
            æ¸…é™¤å®Œæ¯•åï¼Œå°†å½“å‰effectçš„depsæ¸…ç©ºï¼Œå®ŒæˆåŒå‘ä¾èµ–çš„æ¸…é™¤
      ğŸš©parentï¼Œåœ¨effectæ·±å±‚è°ƒç”¨æ—¶ï¼Œè®°å½•ä¸Šä¸€å±‚effectå®ä¾‹
      ğŸš©run()ä¸­æ‰§è¡Œå­ç±»å¯¹è±¡ä¸Šå›è°ƒå‡½æ•°ï¼ŒåŒæ—¶å¯ä»¥æ‰©å±•æ‰§è¡Œé€»è¾‘é“¾
        ğŸŒ try finally å¤„ç†effectåµŒå¥—æ—¶ï¼ŒactvieEffectæŒ‡å‘ä¸¢å¤±é—®é¢˜
          example:
          effect(()=>{
            proxy.name = 1;
            effect(()=>{
              proxy.name = 2
            })
            proxy.age = 18
          })
        effect1è¢«è°ƒç”¨
          activeEffectæŒ‡å‘effect1,æ­¤æ—¶æ›´æ–°ä¾èµ–æ•°æ®è¡¨ä¸­proxy.nameçš„å†…å®¹
          [->effect1]
        effect2è¢«è°ƒç”¨
          activeEffectæŒ‡å‘effect2,æ­¤æ—¶æ›´æ–°ä¾èµ–æ•°æ®è¡¨ä¸­proxy.nameçš„å†…å®¹ [effect1->effect2]  
        ğŸŒŸ actvieEffectéœ€é‡æ–°æŒ‡å‘effect1ï¼Œå¦åˆ™proxy.ageæ— æ³•è®°å½• effect1

        é…åˆtry...finally ï¼Œtryä¸­çš„ä»£ç æ²¡æ‰§è¡Œå®Œï¼Œå³å›è°ƒæ²¡æ‰§è¡Œå®Œï¼Œä¸ä¼šæ‰§è¡Œfinallyä¸­çš„ä»£ç 
        Â·Â·Â·Â·è¿›tryæ—¶ï¼Œä¼šå°†activeEffectæŒ‡å‘å½“å‰effect
        Â·Â·Â·Â·å®Œæˆè¯¥å›è°ƒçš„é€»è¾‘åï¼Œä¼šåœ¨finallyä¸­å°†activeEffectæŒ‡å›ä¸Šä¸€å±‚çš„effect
      ğŸš©activeï¼Œç”¨äºæ§åˆ¶ä¾èµ–æ”¶é›†çš„é˜€é—¨ï¼Œè‹¥activeä¸ºfalseï¼Œåˆ™åœæ­¢ä¾èµ–æ”¶é›†ï¼Œè¿›ä¸åˆ°runçš„é€»è¾‘
      ğŸš©stop()ä¸­è°ƒç”¨cleanEffectæ¸…é™¤ä¾èµ–å…³ç³»ï¼Œå°†activeæ”¹ä¸ºfalseï¼Œåœæ­¢ä¾èµ–æ”¶é›†
      
    âœ¨ => effect
      ğŸš©ç”ŸæˆReactiveEffectå­ç±»ï¼Œé€šè¿‡ .run()æ‰§è¡Œå›è°ƒå‡½æ•°
      ğŸš©effectå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå€¼runner
        âš½ï¸ v3ä¸­é€šè¿‡ _effect.run.bind() å°†ReactiveEffectä¸­çš„åŸå‹æ–¹æ³•runå–å‡º(åŒæ—¶é€šè¿‡bindæŒ‡å‘å½“å‰çš„effectå®ä¾‹å¯¹è±¡)
        âš½ï¸ å†å°†effectå®ä¾‹èµ‹å€¼ç»™runner.effect
      effectè¿”å›çš„runneræœ‰ä¸¤ä¸ªä½œç”¨ï¼š
        1.ç›´æ¥runner()æ‰‹åŠ¨æ¸²æŸ“è§†å›¾ 
        2.èƒ½è·å–åˆ°å½“å‰effectå®ä¾‹ï¼Œè°ƒç”¨effectä¸Šçš„å…¶ä»–åŸå‹æ–¹æ³•ï¼Œå¦‚runner.effect.stop åœæ­¢ä¾èµ–æ”¶é›†
    âœ¨ => actvieEffect
      ğŸš©æ ‡è®°å½“å‰æ‰§è¡Œçš„effectï¼ˆeffectè¢«è°ƒç”¨ï¼ŒactiveEffectæŒ‡å‘è¢«è°ƒç”¨çš„effectï¼‰
        ---å…·ä½“å¼•ç”¨:
        âš½ï¸ trackä¸ºè¢«å¼•ç”¨æ•°æ®åšä¾èµ–æ”¶é›†æ—¶ï¼Œèƒ½åˆ¤æ–­å½“å‰effectæ˜¯å¦å·²è¢«æ”¶é›†
        âš½ï¸ triggeræé†’æ›´æ–°æ•°æ®çš„effectsé˜Ÿåˆ—æ‰§è¡Œæ—¶ï¼Œåˆ¤æ–­è¢«æ‰§è¡Œçš„effectæ˜¯ä¸æ˜¯å½“å‰è¢«è°ƒç”¨çš„effectï¼Œé˜²æ­¢æ­»å¾ªç¯
          åœºæ™¯ä¸¾ä¾‹ï¼šeffect(example)è¢«æ‰§è¡Œ exampleä¸­æ›´æ”¹äº†aæ•°æ®
                    è§¦å‘set -> trigger(æ‰§è¡Œeffects) -> åˆæ‰§è¡ŒåŒä¸€ä¸ªeffect -> ...
                  åœ¨triggerä¸­å¾ªç¯effectsé˜Ÿåˆ—ï¼Œæ‰§è¡Œeffectæ—¶ï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯åŒä¸€ä¸ªeffectï¼Œè‹¥æ˜¯ï¼Œåˆ™ä¸æ‰§è¡Œï¼Œé¿å…æ­»å¾ªç¯
    âœ¨ => reactiveMap å…ƒæ•°æ®ä¾èµ–å…³ç³»è¡¨ï¼ˆå“ªä¸ªeffectä¾èµ–å“ªäº›æ•°æ®ï¼‰
      ğŸš©reactiveMap = {obj:{name:[effect1,effect2,...]}}
    âœ¨ => track ä¾èµ–æ”¶é›†å‡½æ•°
      effectåœ¨è°ƒç”¨æ—¶ï¼Œå¼•ç”¨äº†å“ªäº›æ•°æ®ï¼ˆdetailDataï¼‰
        trackå°±ä¼šåœ¨reactiveMapä¸­çš„detailData(å½“å‰æ•°æ®)å¯¹åº”çš„Set[]å¯»æ‰¾å½“å‰effectï¼Œè‹¥æ²¡æœ‰ï¼Œåˆ™å°†effectæ·»åŠ è¿›å»
        åŒæ—¶å°†detailData(å½“å‰æ•°æ®)çš„Set[]å­˜æ”¾åˆ°effectå®ä¾‹ä¸Šdepsä¸­ï¼Œç”¨äºcleanEffectçš„æ¸…é™¤
    âœ¨ => trigger effectæ‰§è¡Œé€šçŸ¥å‡½æ•°
        åœ¨reactiveMapä¸­æ‰¾åˆ°detailData(å½“å‰æ•°æ®)ï¼Œå¾ªç¯éå†effectsï¼Œæ‰§è¡Œä½¿ç”¨detailDataçš„æ‰€æœ‰effect
        ğŸš© effects = new Set(effects)
        éå†effectæ‰€å­˜æ”¾çš„è¡¨æ ¼(effects)ä¹‹å‰ï¼Œéœ€è¦å°†å½“å‰Setè¡¨æ˜ å°„å‡ºä¸€ä¸ªæ–°çš„Setè¡¨ï¼Œå†è¿›è¡Œéå†æ¸…é™¤æ“ä½œ,å¦åˆ™åœ¨ReactiveEffect.prototype.runä¸­ï¼Œå…ˆæ¸…é™¤ä¾èµ–å…³ç³»ï¼Œåˆé‡æ–°æ”¶é›†ä¾èµ–ï¼Œä¼šå¯¼è‡´æ­»å¾ªç¯ï¼Œ
        è¦çš„æ•ˆæœæ˜¯ï¼šæ¸…é™¤æ—§ä¾èµ–æ•°æ®ï¼Œæ”¶é›†æ–°ä¾èµ–æ•°æ®
    âœ¨ => cleanEffect ä¾èµ–æ¸…é™¤å‡½æ•°
        ğŸš© effectä¸­å¯èƒ½ä¼šå‡ºç°è¯¥åœºæ™¯:
          proxy.flag(boolean) ? proxy.name : proxy.age
        å¼‚æ­¥ä¸­booleançš„çŠ¶æ€è¢«æ”¹å˜ï¼Œåˆ™effectä¸­ä½¿ç”¨çš„æ•°æ®ä¹Ÿåœ¨nameå’Œageä¹‹é—´è¿›è¡Œåˆ‡æ¢
        å³æ¯æ¬¡effectè¢«è°ƒç”¨å‰ï¼Œéƒ½åº”è¯¥æ¸…é™¤è¯¥effectçš„æ‰€æœ‰ä¾èµ–ï¼Œå†æ‰§è¡Œå›è°ƒï¼Œä¼šé‡æ–°å»ºç«‹æœ€æ–°çš„ä¾èµ–å…³ç³»
        exampleï¼š
        state 1ğŸŒ› effect(()=>{ proxy.flag(true) ? proxy.name : proxy.age })
        reactiveMap:{
          proxy:{
            flag:[effect]
            name:[effect]
          }
        }
        æ­¤æ—¶å¼‚æ­¥ä¸­ï¼Œproxy.flag = false -> proxy.set -> trigger
        é€šçŸ¥flagçš„æ‰€æœ‰effectæ‰§è¡Œï¼Œæ›´æ–°è§†å›¾
        â¬‡ï¸
        state 2ğŸŒ› effect(()=>{ proxy.flag(false) ? proxy.name : proxy.age })
        åœ¨_effect.runæ‰§è¡Œä¸­ï¼Œè‹¥ä¸æ¸…é™¤ä¹‹å‰çš„ä¾èµ–å…³ç³»ï¼Œåˆ™å‡ºç°è¿™ç§æƒ…å†µ
        reactiveMap:{
          proxy:{
            flag:[effect]
            name:[effect]
            age:[effect]
          }
        }
        effectä¸­flag: falseçš„æƒ…å†µä¸‹ï¼Œæ²¡è¯»å–proxy.name,ä½†nameä»ä¿å­˜ä¾èµ–å…³ç³»
        å½“proxy.nameæ›´æ–°ï¼Œè§¦å‘proxy.setï¼Œè°ƒç”¨triggerä¼šå†è¿›è¡Œå¤šä½™çš„effectæ‰§è¡Œæ“ä½œ
        ğŸŒ è§£å†³æ€è·¯ï¼š
        éå†effect.depsè¿›è¡Œä¾èµ–æ¸…é™¤é€»è¾‘ï¼Œå…ˆåœ¨æ‰€æœ‰æ‹¥æœ‰å½“å‰effectçš„æ•°æ®ä¸­ï¼Œåˆ é™¤effectï¼Œå†æ¸…ç©ºå½“å‰effectæœ¬èº«çš„depsï¼Œè§£å†³åŒå‘ä¾èµ–å…³ç³»
