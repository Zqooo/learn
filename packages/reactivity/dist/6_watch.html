<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <script src="./reactivity.global.js"></script>
  <!-- <script src="../../../node_modules/vue/dist/vue.global.js"></script> -->
  <div id="app"></div>
  <script>
    const {
      effect,
      reactive,
      computed,
      watch
    } = VueReactivity;
    // const {effect, reactive, computed, watch} = Vue;
    const state = reactive({
      no: 0
    })

    /*
      watch_Vue3
      âœ¨åœ¨vue2æˆ–vue3ä¸­ï¼Œç›‘è§†ç›®æ ‡å¦‚æžœæ˜¯ä¸ªå¯¹è±¡ï¼Œæ— æ³•èŽ·å–åˆ°å…·ä½“çš„æ–°å€¼æˆ–æ—§å€¼ï¼Œè¿”å›žçš„å€¼æ˜¯ä¸€ä¸ªæœ€æ–°åŠ¨æ€çš„ä»£ç†å¯¹è±¡
        å¦‚æžœç›‘æŽ§çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé»˜è®¤æ·±åº¦ç›‘æŽ§ï¼ˆðŸŒå°½é‡ä¸è¦ç›´æŽ¥ç›‘æŽ§æŸä¸ªå¯¹è±¡ï¼Œé»˜è®¤ä¼šé€’å½’è®¿é—®å¯¹è±¡çš„å±žæ€§ï¼‰
      âœ¨watchç›‘è§†æŸä¸ªå“åº”å¼æ•°æ®çš„å±žæ€§ï¼Œéœ€è¦å†™æˆå‡½æ•°çš„å½¢å¼
    */

    let i = 3000;

    function getData(timer) {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          resolve(timer)
        }, timer);
      })
    }

    /*
      é—®é¢˜åœºæ™¯: é€šè¿‡watchå‘é€è¯·æ±‚ï¼Œåˆ†åˆ«æœ‰ä¸¤ä¸ªè¯·æ±‚ï¼š
        state.no = 1 æ—¶ï¼Œå‘é€è¯·æ±‚ä¸€ï¼Œè¯·æ±‚æ—¶é—´ä¸º2000msï¼Œå°†è§†å›¾æ”¹ä¸º2000
        state.no = 2 æ—¶ï¼Œå‘é€è¯·æ±‚äºŒï¼Œè¯·æ±‚æ—¶é—´ä¸º1000msï¼Œå°†è§†å›¾æ”¹ä¸º1000
      é—®é¢˜å…³é”®: 
        ç›®æ ‡æ•°æ®æ”¹å˜æ—¶ï¼Œåº”è¯¥ä»¥æœ€æ–°åŠ¨æ€è¿›è¡Œè§†å›¾æ¸²æŸ“ï¼Œstate.no = 2ä¸ºæœ€æ–°åŠ¨æ€
        ä½†å› ä¸ºè¯·æ±‚äºŒçš„å“åº”æ—¶é—´æ¯”è¯·æ±‚ä¸€å¿«ï¼Œè¢«è¯·æ±‚ä¸€çš„åŠ¨æ€è¦†ç›–ï¼Œå¯¼è‡´è¯•å›¾åœç•™åœ¨ä¸Šä¸€æ¬¡æ•°æ®æ›´æ”¹çš„æ¸²æŸ“çŠ¶æ€
      è§£å†³æ–¹æ¡ˆ:
        ä½¿ç”¨onCleanupï¼Œåˆ©ç”¨é—­åŒ…çš„åŽŸç†ï¼Œè®¾ç½®æŽ§åˆ¶é˜€
      åŠŸèƒ½åŽŸç†ï¼š 
        åœ¨watchä¸­ï¼Œcleanupä¼šåœ¨ä¸‹æ¬¡åŠ¨æ€æ›´æ”¹çš„æ‰§è¡Œå‡½æ•°ä¸­è§¦å‘ï¼Œæ›´æ”¹ä¸Šä¸€æ¬¡åŠ¨æ€ä¸­é˜€é—¨å€¼ï¼Œé™åˆ¶è¯·æ±‚æ•°æ®åˆ°è¾¾æ—¶çš„é€»è¾‘è¿è¡Œ
    */        
    watch(() => state.no, async (newVal, oldVal, onCleanup) => {
      let passFlag = true
      onCleanup(() => {
        passFlag = false
      })
      i-=1000
      const inner = await getData(i)
      passFlag && (app.innerHTML = inner)
    })

    state.no = 1
    state.no = 2
  </script>
</body>

</html>